version: '3.9'
services:
  db:
    image: mongo:7.0
    container_name: kitchen-db
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: Secret123!
    volumes:
      - mongo-data:/data/db
      - ./db/init:/docker-entrypoint-initdb.d:ro
    networks: [kitchen-net]
    ports: ['27017:27017']
    healthcheck:
      test: ['CMD','mongosh','--quiet','--eval','db.adminCommand("ping").ok']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  api:
    build: { context: ./api, target: production }
    image: kitchen-api:local
    environment:
      MONGO_URI: 'mongodb://admin:Secret123!@db:27017/kitchendb?authSource=admin'
      PORT: '3000'
    ports: ['3000:3000']
    depends_on: { db: { condition: service_healthy } }
    networks: [kitchen-net]

  web-ui:
    build: { context: ./web-ui }
    image: kitchen-web:local
    ports: ['8080:80']
    depends_on: { api: { condition: service_healthy } }
    networks: [kitchen-net]

networks:
  kitchen-net: { driver: bridge, name: kitchen-network }
volumes:
  mongo-data: { driver: local, name: kitchen-mongo-data }